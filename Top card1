package com.yourcompany.pts.controller;

import com.yourcompany.pts.dto.request.GlobalFilterRequestDto;
import com.yourcompany.pts.dto.response.RagStatusDataDto;
import com.yourcompany.pts.service.RagStatusService;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@RequestMapping("/api/dashboard")
public class RagStatusController {

    private final RagStatusService ragStatusService;

    public RagStatusController(RagStatusService ragStatusService) {
        this.ragStatusService = ragStatusService;
    }

    /**
     * Fetch Use Case count grouped by Project Overall RAG Status
     * Supports all global filters (optional / multi-select)
     */
    @PostMapping("/rag-status")
    public ResponseEntity<List<RagStatusDataDto>> getRagStatus(
            @RequestBody(required = false) GlobalFilterRequestDto request) {

        // If frontend sends empty body
        if (request == null) {
            request = new GlobalFilterRequestDto();
        }

        List<RagStatusDataDto> response =
                ragStatusService.fetchRagStatus(request);

        return ResponseEntity.ok(response);
    }
}











/// dto





package com.yourcompany.pts.dto.request;

import com.fasterxml.jackson.annotation.JsonProperty;
import lombok.Data;

import java.util.List;

@Data
public class GlobalFilterRequestDto {

    /* ================= BASIC FILTERS ================= */

    @JsonProperty("USE_CASE_NO")
    private List<String> useCaseNo;

    @JsonProperty("USE_CASE_OWNERSHIP")
    private List<String> useCaseOwnership;

    @JsonProperty("USE_CASE_OWNER")
    private List<String> useCaseOwner;

    @JsonProperty("USE_CASE_ACCOUNTABLE_EXECUTIVE")
    private List<String> useCaseAccountableExecutive;

    @JsonProperty("USE_CASE_CATEGORY")
    private List<String> useCaseCategory;

    @JsonProperty("PROJECT_OVERALL_RAG_STATUS")
    private List<String> projectOverallRagStatus;

    @JsonProperty("SMT_ACCOUNTABLE_EXECUTIVE")
    private List<String> smtAccountableExecutive;

    @JsonProperty("DELIVERABLE_OWNER")
    private List<String> deliverableOwner;

    @JsonProperty("PROGRAM_NAME")
    private List<String> programName;

    @JsonProperty("WORK_EFFORT_NAME")
    private List<String> workEffortName;

    @JsonProperty("DERIVED_PROGRAM_CATEGORY")
    private List<String> derivedProgramCategory;

    @JsonProperty("OCC_CONSENT_ORDER_ARTICLE")
    private List<String> occConsentOrderArticle;

    @JsonProperty("SUBPORTFOLIO_NAME")
    private List<String> subportfolioName;

    @JsonProperty("MILESTONE_RAG_STATUS")
    private List<String> milestoneRagStatus;

    /* ================= DERIVED DATE FILTERS (ONLY 3) ================= */

    @JsonProperty("MILESTONE_YEAR")
    private List<Integer> milestoneYear;

    @JsonProperty("MILESTONE_QTR")
    private List<String> milestoneQtr;

    @JsonProperty("MILESTONE_MONTH")
    private List<String> milestoneMonth;
}









package com.yourcompany.pts.dto.response;

import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;

@Data
@NoArgsConstructor
@AllArgsConstructor
public class RagStatusDataDto {

    private String projectOverallRagStatus;
    private Long useCaseCount;
}








// service 





package com.yourcompany.pts.service;

import com.yourcompany.pts.dto.request.GlobalFilterRequestDto;
import com.yourcompany.pts.dto.response.RagStatusDataDto;
import com.yourcompany.pts.repository.RagStatusRepository;
import org.springframework.stereotype.Service;

import java.util.List;

@Service
public class RagStatusService {

    private final RagStatusRepository repository;

    public RagStatusService(RagStatusRepository repository) {
        this.repository = repository;
    }

    public List<RagStatusDataDto> fetchRagStatus(GlobalFilterRequestDto request) {
        return repository.getRagStatusCount(request);
    }
}






// repo






package com.yourcompany.pts.repository;

import com.yourcompany.pts.dto.request.GlobalFilterRequestDto;
import com.yourcompany.pts.dto.response.RagStatusDataDto;
import com.yourcompany.pts.util.GlobalFilterSqlBuilder;
import org.springframework.jdbc.core.NamedParameterJdbcTemplate;
import org.springframework.jdbc.core.namedparam.MapSqlParameterSource;
import org.springframework.stereotype.Repository;

import java.util.List;

@Repository
public class RagStatusRepository {

    private final NamedParameterJdbcTemplate jdbcTemplate;

    public RagStatusRepository(NamedParameterJdbcTemplate jdbcTemplate) {
        this.jdbcTemplate = jdbcTemplate;
    }

    public List<RagStatusDataDto> getRagStatusCount(GlobalFilterRequestDto request) {

        StringBuilder sql = new StringBuilder(
            "SELECT PROJECT_OVERALL_RAG_STATUS, " +
            "COUNT(DISTINCT USE_CASE_NO) AS USE_CASE_COUNT " +
            "FROM CFMUDMCC.ROCK_CO_PTS_EXEC_DSHBRD_VW " +
            "WHERE CO_TYPE = 'CO Milestone' " +
            "AND USE_CASE_NO IS NOT NULL " +
            "AND PROJECT_OVERALL_RAG_STATUS <> 'NA' " +
            "AND RAG_STATUS <> 'NA' "
        );

        MapSqlParameterSource params = new MapSqlParameterSource();

        // ðŸ”¹ Apply reusable global filters
        GlobalFilterSqlBuilder.applyFilters(sql, params, request);

        sql.append(" GROUP BY PROJECT_OVERALL_RAG_STATUS");

        return jdbcTemplate.query(
            sql.toString(),
            params,
            (rs, rowNum) -> {
                RagStatusDataDto dto = new RagStatusDataDto();
                dto.setProjectOverallRagStatus(rs.getString("PROJECT_OVERALL_RAG_STATUS"));
                dto.setUseCaseCount(rs.getLong("USE_CASE_COUNT"));
                return dto;
            }
        );
    }
}










// gfbuilder






package com.yourcompany.pts.util;

import com.yourcompany.pts.dto.request.GlobalFilterRequestDto;
import org.springframework.jdbc.core.namedparam.MapSqlParameterSource;

public final class GlobalFilterSqlBuilder {

    private GlobalFilterSqlBuilder() {
        // utility class
    }

    public static void applyFilters(
            StringBuilder sql,
            MapSqlParameterSource params,
            GlobalFilterRequestDto request
    ) {

        /* ================= BASIC DB COLUMN FILTERS ================= */

        addInFilter(sql, params, "USE_CASE_NO", request.getUseCaseNo());
        addInFilter(sql, params, "USE_CASE_OWNERSHIP", request.getUseCaseOwnership());
        addInFilter(sql, params, "USE_CASE_OWNER", request.getUseCaseOwner());
        addInFilter(sql, params, "USE_CASE_ACCOUNTABLE_EXECUTIVE", request.getUseCaseAccountableExecutive());
        addInFilter(sql, params, "USE_CASE_CATEGORY", request.getUseCaseCategory());
        addInFilter(sql, params, "PROJECT_OVERALL_RAG_STATUS", request.getProjectOverallRagStatus());
        addInFilter(sql, params, "SMT_ACCOUNTABLE_EXECUTIVE", request.getSmtAccountableExecutive());
        addInFilter(sql, params, "DELIVERABLE_OWNER", request.getDeliverableOwner());
        addInFilter(sql, params, "PROGRAM_NAME", request.getProgramName());
        addInFilter(sql, params, "WORK_EFFORT_NAME", request.getWorkEffortName());
        addInFilter(sql, params, "DERIVED_PROGRAM_CATEGORY", request.getDerivedProgramCategory());
        addInFilter(sql, params, "OCC_CONSENT_ORDER_ARTICLE", request.getOccConsentOrderArticle());
        addInFilter(sql, params, "SUBPORTFOLIO_NAME", request.getSubportfolioName());

        /* ================= DERIVED DATE FILTERS (ONLY 3) ================= */

        addYearFilter(sql, params, "MILESTONE_YEAR", request.getMilestoneYear());
        addQuarterFilter(sql, params, "MILESTONE_QTR", request.getMilestoneQtr());
        addMonthFilter(sql, params, "MILESTONE_MONTH", request.getMilestoneMonth());
    }

    /* ================= GENERIC HELPERS ================= */

    private static void addInFilter(
            StringBuilder sql,
            MapSqlParameterSource params,
            String column,
            Object values
    ) {
        if (values != null) {
            sql.append(" AND ")
               .append(column)
               .append(" IN (:")
               .append(column)
               .append(")");
            params.addValue(column, values);
        }
    }

    private static void addYearFilter(
            StringBuilder sql,
            MapSqlParameterSource params,
            String paramName,
            Object values
    ) {
        if (values != null) {
            sql.append(" AND EXTRACT(YEAR FROM DUE_DATE) IN (:")
               .append(paramName)
               .append(")");
            params.addValue(paramName, values);
        }
    }

    private static void addQuarterFilter(
            StringBuilder sql,
            MapSqlParameterSource params,
            String paramName,
            Object values
    ) {
        if (values != null) {
            sql.append(" AND ('Q' || TO_CHAR(DUE_DATE,'Q') || ' ' || TO_CHAR(DUE_DATE,'YYYY'))")
               .append(" IN (:")
               .append(paramName)
               .append(")");
            params.addValue(paramName, values);
        }
    }

    private static void addMonthFilter(
            StringBuilder sql,
            MapSqlParameterSource params,
            String paramName,
            Object values
    ) {
        if (values != null) {
            sql.append(" AND TO_CHAR(DUE_DATE,'Mon YYYY') IN (:")
               .append(paramName)
               .append(")");
            params.addValue(paramName, values);
        }
    }
}

















